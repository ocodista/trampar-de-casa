name: Verify and Bump Version

on:
  push
  # pull_request:
  #   branches:
  #     - main # Trigger the action on PRs targeting the main branch

jobs:
  verify-and-bump:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the PR branch
      uses: actions/checkout@v3
      with:
        ref: ${{ github.head_ref }}

    - name: Get version from PR branch
      id: pr-version
      run: |
        PR_VERSION=$(jq -r '.version' apps/web/package.json)
        echo "::set-output name=pr_version::${PR_VERSION}"

    - name: Checkout the main branch
      uses: actions/checkout@v3
      with:
        ref: main

    - name: Get version from main branch
      id: main-version
      run: |
        MAIN_VERSION=$(jq -r '.version' apps/web/package.json)
        echo "::set-output name=main_version::${MAIN_VERSION}"

    - name: Compare versions
      run: |
        if [ "${{ steps.pr-version.outputs.pr_version }}" != "${{ steps.main-version.outputs.main_version }}" ]; then
          echo "The versions are different."
          exit 0
        else
          echo "The versions are the same. Bump required."
          exit 1

    - name: Checkout the PR branch
      uses: actions/checkout@v3
      with:
        ref: ${{ github.head_ref }}
        fetch-depth: 0

    - name: Bump version
      if: always()
      working-directory: apps/web
      run: npm version patch

    - name: Commit changes
      if: always()
      run: |
        git add apps/web/package.json
        git config user.name "GitHub Actions Bot"
        git config user.email "<>"
        git commit -m "Bump version in apps/web"
        git push origin ${{ github.head_ref }}
